name: Build and Release whisper.cpp macOS Binaries

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:
    inputs:
      whisper_version:
        description: 'whisper.cpp version/tag to build (e.g., v1.8.2, master)'
        required: true
        default: 'master'
      release_tag:
        description: 'Release tag for this build (e.g., v1.8.2-1)'
        required: true

env:
  WHISPER_REPO: https://github.com/ggml-org/whisper.cpp.git

jobs:
  build:
    name: Build whisper.cpp - ${{ matrix.config.name }}
    runs-on: ${{ matrix.config.os }}
    strategy:
      fail-fast: false
      matrix:
        config:
          # Apple Silicon (ARM64) with Metal GPU support
          - name: "macOS ARM64 (Metal GPU)"
            os: macos-14  # macOS 14 (Sonoma) runs on Apple Silicon
            arch: arm64
            cmake_flags: "-DGGML_METAL=ON -DGGML_ACCELERATE=ON -DCMAKE_OSX_ARCHITECTURES=arm64"
            deployment_target: "13.0"
            artifact_suffix: "macos-arm64-metal"
            cc_target: ""
            cxx_target: ""
            sdl2_enabled: "ON"
            
          # Intel (x86_64) with Accelerate framework - Cross-compiled on ARM64
          # Metal is disabled for x86_64 as it's Apple Silicon only
          # SDL2 is disabled to avoid cross-compilation linking issues
          - name: "macOS x86_64 (Accelerate)"
            os: macos-14  # Use ARM64 runner and cross-compile for x86_64
            arch: x86_64
            cmake_flags: "-DGGML_METAL=OFF -DGGML_ACCELERATE=ON -DCMAKE_OSX_ARCHITECTURES=x86_64 -DGGML_NATIVE=OFF"
            deployment_target: "13.3"
            artifact_suffix: "macos-x86_64-accelerate"
            cc_target: "-target x86_64-apple-macos13.3"
            cxx_target: "-target x86_64-apple-macos13.3"
            sdl2_enabled: "OFF"

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set whisper.cpp version
        id: set_version
        run: |
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            echo "WHISPER_VERSION=${{ github.event.inputs.whisper_version }}" >> $GITHUB_ENV
            echo "RELEASE_TAG=${{ github.event.inputs.release_tag }}" >> $GITHUB_ENV
          else
            # Extract version from git tag
            VERSION=${GITHUB_REF#refs/tags/}
            echo "WHISPER_VERSION=${VERSION}" >> $GITHUB_ENV
            echo "RELEASE_TAG=${VERSION}" >> $GITHUB_ENV
          fi
          echo "Building whisper.cpp version: $WHISPER_VERSION"

      - name: Clone whisper.cpp repository
        run: |
          git clone --depth 1 --branch ${{ env.WHISPER_VERSION }} ${{ env.WHISPER_REPO }} whisper-src || \
          git clone ${{ env.WHISPER_REPO }} whisper-src && cd whisper-src && git checkout ${{ env.WHISPER_VERSION }}

      - name: Install dependencies
        run: |
          brew update
          # Install SDL2 for stream example (only for ARM64 native builds)
          if [ "${{ matrix.config.sdl2_enabled }}" == "ON" ]; then
            brew install sdl2
          fi

      - name: Build whisper.cpp
        working-directory: whisper-src
        run: |
          echo "Building for ${{ matrix.config.arch }} with flags: ${{ matrix.config.cmake_flags }}"
          
          # Set compiler flags for cross-compilation if needed
          export CFLAGS="${{ matrix.config.cc_target }}"
          export CXXFLAGS="${{ matrix.config.cxx_target }}"
          
          # Configure CMake with optimization flags
          cmake -B build \
            ${{ matrix.config.cmake_flags }} \
            -DCMAKE_BUILD_TYPE=Release \
            -DCMAKE_OSX_DEPLOYMENT_TARGET=${{ matrix.config.deployment_target }} \
            -DWHISPER_SDL2=${{ matrix.config.sdl2_enabled }} \
            -DBUILD_SHARED_LIBS=OFF \
            .
          
          # Build with all available cores
          cmake --build build -j$(sysctl -n hw.ncpu) --config Release

      - name: Verify build
        working-directory: whisper-src
        run: |
          echo "Verifying built binaries..."
          ls -lh build/bin/
          
          # Check architecture
          for binary in build/bin/whisper-*; do
            if [ -f "$binary" ]; then
              echo "=== $binary ==="
              file "$binary"
              lipo -info "$binary" 2>/dev/null || true
            fi
          done

      - name: Create distribution package
        working-directory: whisper-src
        run: |
          DIST_DIR="whisper-cpp-${{ env.WHISPER_VERSION }}-${{ matrix.config.artifact_suffix }}"
          mkdir -p "$DIST_DIR"/{bin,models,samples}
          
          # Copy binaries
          cp -v build/bin/whisper-* "$DIST_DIR/bin/" || true
          
          # Copy essential files
          cp -v README.md LICENSE "$DIST_DIR/" || true
          
          # Copy model download scripts
          cp -v models/download-ggml-model.sh "$DIST_DIR/models/" || true
          cp -v models/download-vad-model.sh "$DIST_DIR/models/" || true
          
          # Copy sample audio files if they exist
          cp -v samples/*.wav "$DIST_DIR/samples/" 2>/dev/null || true
          
          # Create README for the distribution
          cat > "$DIST_DIR/README.txt" << 'EOF'
          whisper.cpp macOS Distribution
          ================================
          
          Architecture: ${{ matrix.config.arch }}
          Configuration: ${{ matrix.config.name }}
          Version: ${{ env.WHISPER_VERSION }}
          Build Date: $(date)
          
          CONTENTS:
          ---------
          bin/          - Compiled binaries
          models/       - Model download scripts
          samples/      - Sample audio files (if included)
          
          QUICK START:
          ------------
          1. Download a model:
             cd models
             ./download-ggml-model.sh base.en
          
          2. Transcribe audio:
             cd ..
             ./bin/whisper-cli -m models/ggml-base.en.bin -f samples/jfk.wav
          
          GPU ACCELERATION:
          -----------------
          ${{ matrix.config.arch == 'arm64' && 'This build includes Metal GPU support for Apple Silicon.' || 'This build uses Accelerate framework for optimized CPU performance.' }}
          
          For more information, visit:
          https://github.com/ggml-org/whisper.cpp
          
          EOF
          
          # Create tarball
          tar -czf "$DIST_DIR.tar.gz" "$DIST_DIR"
          
          # Generate checksums
          shasum -a 256 "$DIST_DIR.tar.gz" > "$DIST_DIR.tar.gz.sha256"
          
          echo "Package created: $DIST_DIR.tar.gz"
          ls -lh "$DIST_DIR.tar.gz"

      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: whisper-cpp-${{ matrix.config.artifact_suffix }}
          path: |
            whisper-src/whisper-cpp-*.tar.gz
            whisper-src/whisper-cpp-*.tar.gz.sha256
          retention-days: 7

  create-release:
    name: Create GitHub Release
    needs: build
    runs-on: ubuntu-latest
    if: github.event_name == 'workflow_dispatch' || startsWith(github.ref, 'refs/tags/')
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set release info
        id: release_info
        run: |
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            echo "RELEASE_TAG=${{ github.event.inputs.release_tag }}" >> $GITHUB_ENV
            echo "WHISPER_VERSION=${{ github.event.inputs.whisper_version }}" >> $GITHUB_ENV
          else
            VERSION=${GITHUB_REF#refs/tags/}
            echo "RELEASE_TAG=${VERSION}" >> $GITHUB_ENV
            echo "WHISPER_VERSION=${VERSION}" >> $GITHUB_ENV
          fi

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: Prepare release assets
        run: |
          mkdir -p release-assets
          find artifacts -name "*.tar.gz*" -exec cp {} release-assets/ \;
          ls -lh release-assets/

      - name: Generate release notes
        run: |
          cat > release-notes.md << 'EOF'
          # whisper.cpp macOS Binary Distribution
          
          This release provides pre-built binaries of [whisper.cpp](https://github.com/ggml-org/whisper.cpp) for macOS.
          
          ## ðŸ“¦ Available Builds
          
          ### Apple Silicon (ARM64)
          - **File**: `whisper-cpp-*-macos-arm64-metal.tar.gz`
          - **Architecture**: ARM64 (Apple M1/M2/M3/M4)
          - **GPU Support**: âœ… Metal (Apple GPU acceleration)
          - **Optimizations**: ARM NEON, Accelerate framework
          
          ### Intel (x86_64)
          - **File**: `whisper-cpp-*-macos-x86_64-accelerate.tar.gz`
          - **Architecture**: x86_64 (Intel processors)
          - **GPU Support**: âŒ CPU only
          - **Optimizations**: AVX/AVX2, Accelerate framework
          
          ## ðŸš€ Quick Start
          
          1. Download the appropriate archive for your Mac architecture
          2. Extract the archive: `tar -xzf whisper-cpp-*.tar.gz`
          3. Download a model: `cd whisper-cpp-*/models && ./download-ggml-model.sh base.en`
          4. Run transcription: `cd .. && ./bin/whisper-cli -m models/ggml-base.en.bin -f samples/jfk.wav`
          
          ## ðŸ” Verify Downloads
          
          Each release includes SHA256 checksums. Verify your download:
          ```bash
          shasum -a 256 -c whisper-cpp-*.tar.gz.sha256
          ```
          
          ## ðŸ“‹ System Requirements
          
          - **macOS**: 11.0 (Big Sur) or later
          - **Apple Silicon builds**: Requires Apple M-series processor
          - **Intel builds**: Requires x86_64 processor
          
          ## ðŸ”§ Included Tools
          
          - `whisper-cli` - Command-line transcription tool
          - `whisper-bench` - Performance benchmarking tool
          - `whisper-stream` - Real-time audio transcription
          - `whisper-server` - HTTP API server
          - And more...
          
          ## ðŸ“š Documentation
          
          For detailed usage instructions, visit the [official whisper.cpp repository](https://github.com/ggml-org/whisper.cpp).
          
          ## ðŸ› Issues
          
          Report issues at: https://github.com/bizenlabs/whisper-cpp-macos-bin/issues
          
          ---
          
          **Build Information**:
          - whisper.cpp version: `${{ env.WHISPER_VERSION }}`
          - Build date: `$(date -u +"%Y-%m-%d %H:%M:%S UTC")`
          - Release tag: `${{ env.RELEASE_TAG }}`
          EOF

      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ env.RELEASE_TAG }}
          name: whisper.cpp ${{ env.WHISPER_VERSION }} - macOS Binaries
          body_path: release-notes.md
          draft: false
          prerelease: false
          files: release-assets/*
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Release Summary
        run: |
          echo "âœ… Release created successfully!"
          echo "ðŸ“¦ Release tag: ${{ env.RELEASE_TAG }}"
          echo "ðŸ”– whisper.cpp version: ${{ env.WHISPER_VERSION }}"
          echo ""
          echo "ðŸ“„ Release assets:"
          ls -lh release-assets/
